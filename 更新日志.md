V1.0：主要：修复了原启动方式不够降智的BUG。次要：添加多种修复兼启动方式。
V1.1：主要：修复了妃物群主（@小城之雪）智商太高的BUG。次要：修复了一键启动的目标文件检索问题。新增：无论何种（完全变量或基础变量）方式，麦麦运行成功一次后，第二次运行麦麦仅需双击一键启动文件夹中的run_both.bat文件即可。

# V2.0：修复了启动时只启动了一个窗口的问题。将繁琐的配置精简。

模块化配置管理：
使用独立的config.ini文件存储配置
配置与代码分离，方便分享和修改
智能路径验证：
自动验证路径是否存在
支持带空格的路径（无需手动加引号）
容错机制：
输入验证循环直到输入有效值
自动检测配置文件完整性
友好的错误提示和恢复机制
用户体验优化：
保留命令窗口查看运行状态
清晰的步骤提示和进度反馈
兼容性增强：
强制使用UTF-8编码
兼容不同目录结构
自动处理虚拟环境路径

### V2.1：修复了带空格或特殊字符的路径有时会出BUG的问题。

- 新功能：
  现在配置内容时，可以直接将文件夹或文件拖拽进配置窗口以复制文件路径。

# V3.0：

## 网络代理功能更新（2025-12-13）

### 新增功能
- ✨ **网络代理支持**：新增完整的网络代理功能，支持 HTTP、HTTPS、SOCKS4、SOCKS5 代理
- 🎨 **可视化配置界面**：在配置 UI 的设置页面中添加了代理配置面板
- 🔐 **代理认证**：支持用户名和密码认证
- 🧪 **连接测试**：可在界面中一键测试代理连接是否正常
- 📋 **排除列表**：支持配置不使用代理的主机列表
- 🔄 **自动应用**：代理设置可自动应用到系统环境变量

### 新增文件
- `src/utils/proxy_manager.py` - 代理管理核心模块
- `src/utils/proxy_usage_example.py` - 代理使用示例代码
- `test_proxy.py` - 代理功能快速测试脚本
- `PROXY_USAGE.md` - 详细的代理使用说明文档

### 修改文件
- `src/core/p_config.py` - 添加代理配置项和相关方法
- `src/config_UI/config_UI.py` - 添加代理设置 API 接口
- `src/config_UI/config_UI.js` - 在设置界面中添加代理配置面板

### 使用方法
1. **通过界面配置**：
   - 打开配置 UI
   - 点击右上角"⚙ 设置"按钮
   - 展开"🌐 网络代理设置"
   - 填写代理信息并测试连接
   - 保存设置

2. **在代码中使用**：
   ```python
   from src.utils.proxy_manager import proxy_manager
   import requests
   
   # 方式1：获取代理字典
   proxies = proxy_manager.get_proxies_dict()
   response = requests.get(url, proxies=proxies)
   
   # 方式2：应用到环境变量
   proxy_manager.apply_to_environment()
   response = requests.get(url)  # 自动使用代理
   ```

3. **测试代理功能**：
   ```bash
   python test_proxy.py
   ```

详细使用说明请参考 `PROXY_USAGE.md` 文件。



- 一、功能扩展
  1. 新增启动选项：旧版本仅支持“运行麦麦”和“配置内容”两个基础功能；新版本新增“运行麦麦（同时启动NapCatQQ并检查Mongo DB）”选项，可自动检测NapCatQQ运行状态与MongoDB服务状态，并根据情况执行启动或提示操作，功能更加全面。
  2. 新增退出功能：新版本添加“退出程序”选项，方便用户直接关闭程序，旧版本无此直接退出功能，需手动关闭窗口。
  3. NapCatQQ路径支持：新版本对NapCatQQ程序路径的处理更灵活，支持路径为空的情况，并在启动时进行针对性检查和提示；旧版本未涉及该程序路径相关操作。
- 二、交互优化
  1. 菜单界面：新版本菜单更清晰美观，使用字母A - D作为选项标识，且新增横线、等号分隔元素；旧版本使用数字1、2作为选项，界面相对简洁。
  2. 路径输入：新版本支持将文件夹或路径直接拖入窗口完成输入，无需手动加引号；旧版本仅通过手动输入路径方式，对含空格等特殊字符路径处理不够便捷。
- 三、逻辑与稳定性提升
  1. 错误处理：新版本在错误提示方面更详细，如在选择B选项时，对NapCatQQ和MongoDB的不同状态均有对应提示；运行麦麦时，各步骤错误均有明确回显，且窗口保持打开便于查看问题。旧版本错误提示相对简单，部分场景下可能无法清晰展示错误原因。
  2. 编码设置：新版本明确设置为UTF - 8编码，从根源上避免菜单界面乱码问题；旧版本虽通过`chcp 65001`尝试解决编码问题，但在复杂场景下仍可能出现乱码。
  3. 参数处理：新版本在参数传递和处理上更严谨，减少类似“无法将参数绑定到参数‘FilePath’，因为该参数是空值”等问题；旧版本在复杂路径或参数传递时可能存在潜在逻辑漏洞 。
- 四、技术实现差异
  1. 脚本语言：旧版本基于批处理（.bat）编写；新版本采用PowerShell编写，利用PowerShell强大的系统交互与脚本功能，可更方便地实现任务管理（如检查进程）、服务状态查询（如MongoDB服务）等操作。
     V3.1：
     一、 核心改进
  2. 架构重构
     语言迁移：从 PowerShell 脚本 → Python 程序
     配置文件：INI 格式 → JSON 格式
     模块化设计：使用函数式编程替代过程式脚本
  3. 功能增强
     新增自动路径检索功能
     增加配置验证模块（含中文/文件存在性/必要文件检查）
     新增配置检查菜单（选项D）
     改进虚拟环境激活逻辑
     增强跨平台兼容性（保留Windows特性）
  4. 交互优化
     彩色终端输出（使用colorama库）
     更友好的错误提示系统
  5. 稳定性提升
     增强进程检测逻辑（NapCat/MongoDB）
     改进PowerShell调用方式
     增加32/64位系统兼容处理
     二、变更明细
     功能模块	  	 V3.0			   V3.1
     配置存储	   	INI文件	       		   JSON格式
     路径验证	   	基础存在性检查	  多层验证（文件类型/中文/必要文件）
     虚拟环境	   	硬编码路径	          动态路径检测
     进程管理	   	简单进程检查	    	  注册表级服务检测
     错误处理	   	基础提示	          	  详细错误代码+解决方案建议
     跨平台支持	仅Windows	  	 保留Windows特性+部分Unix兼容

# V3.2

一、核心功能扩展

1. LPMM知识库支持
   新增LPMM知识库构建专属菜单（选项[E]）
   支持知识库一条龙构建流程
   支持文本分割、实体提取、知识图谱导入等独立操作
   优化了PowerShell命令执行机制，提高稳定性
2. 界面优化
   重构菜单结构，增加子菜单系统
   优化颜色方案，提升视觉体验
   改进命令执行状态提示
3. 安全性增强
   增加LPMM操作的用户确认机制
   添加重要操作的警告提示
   优化错误处理和恢复机制
4. 杂项
   新的图标！
   二、LPMM功能详解
5. 知识库一条龙构建
   自动化处理从文本分割到知识图谱导入的完整流程
   支持中途暂停和继续
   提供详细的进度反馈
6. 独立操作支持
   文本分割：处理raw_data目录下的文本文件
   实体提取：支持多种模型选择，包含资源消耗提示
   知识图谱导入：支持多种模型，包含性能需求提示
7. 用户体验优化
   添加操作确认机制
   提供详细的资源消耗提示
   支持失败后的重试机制
   三、变更明细
   功能模块	    ——    V3.1 → 	V3.2
   菜单系统	    ——    单层菜单	→     多层菜单
   LPMM支持	    ——    无	    →     完整支持
   执行机制	    ——    直接执行	→     确认后执行
   错误处理	    ——    基础提示	→     详细错误信息+重试机制
   用户交互	    ——    单向操作	→     交互式操作

# V3.3

### 重大变更

1. **配置文件格式迁移**：

- 从JSON格式迁移到TOML格式，配置文件名为`config.toml`。
- 支持多配置集（多个麦麦实例配置），每个配置集包含：
- 用户自定义序列号（serial_number）
- 绝对序列号（absolute_serial_number，唯一且自动生成）
- 版本号（version_path）
- 昵称（nickname_path）
- 麦麦本体路径（mai_path）
- 适配器路径（adapter_path）
- NapCat路径（napcat_path）

### 新增功能

2. **多实例管理**：

- 支持创建、删除多个麦麦实例配置。
- 启动时可以选择不同的实例。
- 每个实例可以独立配置，包括版本、路径等。

3. **多版本启动支持**：

- 自动识别版本（通过`is_legacy_version`函数），旧版本（小于0.6.0或classical）和新版本（0.6.0及以上）采用不同的启动方式：
- 旧版本：运行`run.bat`启动。
- 新版本：同时启动麦麦本体和适配器（两个PowerShell窗口）。

4. **知识库迁移工具**：

- 新增`migrate_mongodb_to_sqlite`函数，提供从MongoDB到SQLite的迁移功能（主菜单选项E）。
- 迁移前检查MongoDB服务是否运行，并确认操作。

5. **部署辅助系统（开发中）**：

- 新增`Deployment`函数，提供部署菜单（主菜单选项F），目前功能**开发中**，仅展示占位信息。

### 功能改进

6. **配置管理增强**：

- 合并配置检查和配置编辑功能到配置管理菜单（主菜单选项C）。
- 配置集管理子菜单（新建、删除、重新配置）。
- 新建配置集时，要求输入版本号，并根据版本号决定是否配置适配器路径。

7. **LPMM知识库构建改进**：

- 现在在执行LPMM知识库操作前，需要选择目标实例（配置集）。

8. **路径验证逻辑优化**：

- 针对不同版本进行不同的路径验证：
- 旧版本：检查麦麦路径下是否存在`run.bat`。
- 新版本：检查适配器路径和麦麦路径。

### 问题修复

9. **修复配置加载问题**：

- 增强配置加载的健壮性，当配置缺失时使用默认值。
- 修复配置集切换时可能出现的键错误。

10. **其他优化**：

- 优化用户界面，显示更多配置信息。
- 倒计时函数增加更明显的提示。

### 已知问题

- 部署辅助系统（选项F）目前仅是一个框架，功能尚未实现。
- 在配置管理菜单中，删除配置集时仅通过用户序列号删除，可能不够直观。

### 注意事项

- 升级到新版时，旧版JSON配置将不再兼容，需要重新配置。
- 使用知识库迁移功能前，请确保MongoDB服务已启动。

# V3.4

## 一、新增功能

1. 部署辅助系统：

- 支持一键部署多个版本的麦麦实例（包括classical和0.6.0-alpha至0.7.0-alpha）。
- 自动检测并引导安装Python、MongoDB、MongoDB Compass和NapCat。
- 部署过程中可查看所选版本的更新日志。
- 部署完成后自动创建配置集。

2. 实例删除功能：

- 支持彻底删除实例（包括文件删除和配置移除），释放磁盘空间。

3. 彩色输出：

- 使用RGB彩色打印函数，使控制台输出更加美观。

4. 更新日志查询：

- 内置各个版本的更新日志，部署时可查看。

# 二、功能优化

1. 菜单界面优化：

- 重新设计主菜单，按功能分类，并使用彩色标识。
- 配置管理菜单选项使用彩色标识，提升可读性。

2. 配置管理流程优化：

- 新建配置集时，可选择自动检索或手动配置。
- 配置集管理界面显示更详细的信息。

3. 启动逻辑优化：

- 对旧版本（classical）使用run.bat启动，提高兼容性。
- 启动前进行配置验证，确保路径有效。

4. 路径验证增强：

- 检查路径中是否包含中文，避免潜在问题。

5. LPMM知识库构建菜单优化：

- 增加版本提示，避免用户在不支持的版本上使用。

6. 知识库迁移流程优化：

- 增加更多的提示和确认步骤，避免误操作。

## 三、问题修复

1. 修复配置加载时可能出现的异常，避免程序崩溃。
2. 修复旧版本配置中缺少run.bat文件时的错误提示，提供更准确的错误信息。
3. 修复配置集删除功能中可能出现的键错误问题。
4. 修复配置验证逻辑，避免对旧版本误检查适配器路径。
5. 修复启动旧版本时可能出现的路径问题。

## 四、其他

1. 代码重构：

- 将功能模块化，提高代码可读性和可维护性。

2. 引入新依赖：

- 新增requests库用于文件下载。
- 新增zipfile用于解压。
- 新增shutil用于文件操作。
- 新增winreg用于注册表操作（检查MongoDB Compass安装）。

3. 增加错误处理：

- 在关键步骤增加异常捕获，提供友好的错误提示。

# V3.4.1

修复并优化部署辅助系统

# V3.4.2

添加并初步完善` [F] → [G]实例更新`功能，添加并完善` [G] 关于本程序`选项

# **V4.0.0：新生代 (Next-Gen)**

**V4.0.0** 标志着 MaiMbot Initiate 的一次彻底进化。我们告别了传统的脚本模式，迎来了一个基于 Python 的、完全模块化的、面向对象的应用程序架构。这不仅仅是一次版本更新，更是一次新生的重构，旨在提供前所未有的稳定性、可扩展性和用户体验。

---

#### **核心亮点**

* **🚀 全新架构**：从底层完全重写，采用现代化的面向对象设计，代码结构更清晰，可维护性大幅提升。
* **🧩 组件化启动**：将麦麦本体、适配器、NapCat、MongoDB、WebUI 等核心服务抽象为独立的“可启动组件”，实现按需、动态、灵活的启动组合。
* **🌐 可视化配置**：引入基于 Web 的可视化配置编辑器，现在您可以在浏览器中轻松管理和修改所有实例配置（可能吧）。
* **📊 进程状态管理**：新增独立的进程状态监控面板，可以实时查看由启动器启动的所有相关进程（如 `bot.py`, `mongod.exe` 等）的运行状态，并支持一键全部终止(没人测试,有问题记得报告)。
* **🎨 现代化 UI**：全面拥抱 `rich` 库，重制了所有命令行界面，提供更美观、更直观的彩色输出、表格和交互提示。

---

#### **详细变更列表**

**一、 架构与核心**

* **语言与范式迁移**：
  * 从过程式的 Python 脚本 (`main_refactored.py`) 演进为完全的面向对象应用程序 (`class MaiMaiLauncher`)。
  * 引入结构化日志系统 (`structlog`)，所有操作均有详细、规范的日志记录，极大地方便了问题排查。
* **模块化设计**：
  * **UI 分离**：将界面（`src/ui`）、核心逻辑（`src/modules`）和工具函数（`src/utils`）完全解耦。
  * **配置管理**：`config_manager.py` 专职负责 TOML 文件的读写与管理。
  * **启动逻辑**：`launcher.py` 内部实现了高度封装的组件启动与进程管理逻辑。

**二、 功能增强**

* **动态启动菜单**：
  * 启动器会根据您当前实例的配置，动态生成启动选项。例如，只有在配置了 `adapter_path` 后，才会出现“启动麦麦 + 适配器”的选项。
  * 新增“全栈启动”模式，一键启动当前实例所有已配置的可用组件。
* **WebUI 支持**：
  * 正式将 WebUI 纳入启动器管理体系，可作为独立组件与其他服务一同启动。
* **虚拟环境支持**：
  * 启动器会自动检测并优先使用项目目录（或指定路径）下的 Python 虚拟环境，保证了运行环境的纯净与隔离。
* **插件管理框架 (预览)**：
  * 虽然功能尚在开发中，但已内置了完整的插件管理UI流程框架，包括为指定实例安装、卸载和浏览插件，为未来的功能扩展奠定了基础(4.1会有的会有的)。

**三、 用户体验 (UI/UX) 优化**

* **界面重制**：
  * 所有菜单、提示信息、表格均使用 `rich` 库重新渲染，视觉效果和可读性显著提升。
  * 引入了统一的颜色与符号主题 (`src/ui/theme.py`)，界面风格一致且专业。
* **交互改进**：
  * 使用 `rich.prompt` 替代原生 `input()`，提供更友好的输入体验。
  * 关键操作（如删除、迁移）均有二次确认，防止误操作。
* **清晰的组件状态**：
  * 在启动菜单中，会清晰地展示每个组件（如 NapCat, WebUI）是否已配置和可用。

---

#### **已知问题**

* **插件管理**：插件管理功能目前仅包含用户界面和交互流程，尚未与后端逻辑完全对接，将在后续版本中逐步完善。

---

#### V4.0.0.1

向后兼容，优化安装包

---

#### V4.0.0.2

添加新建虚拟环境时的winerror5的问题解决补丁

---

#### V4.0.0.3

这次解决了那些把程序安装到C盘结果权限不足的入的问题
